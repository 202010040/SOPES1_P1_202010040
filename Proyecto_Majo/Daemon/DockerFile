FROM golang:1.19-alpine AS builder

# Instalar dependencias necesarias
RUN apk add --no-cache gcc musl-dev sqlite-dev

WORKDIR /app

# Copiar archivos de dependencias
COPY go.mod go.sum ./
RUN go mod download

# Copiar código fuente
COPY . .

# Compilar la aplicación
RUN CGO_ENABLED=1 GOOS=linux go build -a -installsuffix cgo -o monitor-daemon .

# Imagen final
FROM alpine:latest

# Instalar dependencias necesarias para el runtime
RUN apk add --no-cache ca-certificates sqlite bash docker-cli

WORKDIR /root/

# Copiar binario compilado
COPY --from=builder /app/monitor-daemon .

# Crear directorio para la base de datos
RUN mkdir -p /data

# Exponer puerto si es necesario (para futuras extensiones)
EXPOSE 8080

CMD ["./monitor-daemon"]